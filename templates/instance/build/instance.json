{
  "Parameters": {
    "VolumeSize": {
      "Type": "String",
      "Default": "5"
    },
    "CodeRepository": {
      "Type": "String",
      "Default": "EMPTY"
    },
    "AcceleratorType": {
      "Type": "String",
      "Default": "EMPTY"
    },
    "State": {
      "Type": "String",
      "Default": "ON"
    },
    "LambdaUtilLayer": {
      "Type": "String"
    },
    "OnStartStopDocument": {
      "Type": "String",
      "Default": "EMPTY"
    },
    "OnCreateDeleteDocument": {
      "Type": "String",
      "Default": "EMPTY"
    },
    "ParentStack": {
      "Type": "String"
    },
    "SSMLogGroup": {
      "Type": "String"
    },
    "LogsBucket": {
      "Type": "String"
    },
    "EFS": {
      "Type": "String"
    },
    "InstanceType": {
      "Type": "String"
    },
    "RoleArn": {
      "Type": "String"
    },
    "KmsKeyId": {
      "Type": "String",
      "Default": "EMPTY"
    },
    "SecurityGroupId": {
      "Type": "String"
    },
    "SubnetId": {
      "Type": "String"
    },
    "DirectInternetAccess": {
      "Type": "String",
      "Default": "Enabled"
    },
    "IdleShutdown": {
      "Type": "String",
      "Default": "30"
    },
    "GlueDevEndpoint": {
      "Type": "String",
      "Default": "EMPTY"
    },
    "VPC": {
      "Type": "String"
    },
    "EnableRoot": {
      "Type": "String",
      "AllowedValues": [
        "True",
        "False"
      ],
      "Default": "False"
    }
  },
  "Conditions": {
    "IfVolumeSize": {
      "Fn::Not": [
        {
          "Fn::Equals": [
            {
              "Ref": "VolumeSize"
            },
            "EMPTY"
          ]
        }
      ]
    },
    "IfCodeRepository": {
      "Fn::Not": [
        {
          "Fn::Equals": [
            {
              "Ref": "CodeRepository"
            },
            "EMPTY"
          ]
        }
      ]
    },
    "IfAcceleratorType": {
      "Fn::Not": [
        {
          "Fn::Equals": [
            {
              "Ref": "AcceleratorType"
            },
            "EMPTY"
          ]
        }
      ]
    },
    "IfState": {
      "Fn::Not": [
        {
          "Fn::Equals": [
            {
              "Ref": "State"
            },
            "EMPTY"
          ]
        }
      ]
    },
    "IfOnStartStopDocument": {
      "Fn::Not": [
        {
          "Fn::Equals": [
            {
              "Ref": "OnStartStopDocument"
            },
            "EMPTY"
          ]
        }
      ]
    },
    "IfOnCreateDeleteDocument": {
      "Fn::Not": [
        {
          "Fn::Equals": [
            {
              "Ref": "OnCreateDeleteDocument"
            },
            "EMPTY"
          ]
        }
      ]
    },
    "IfKmsKeyId": {
      "Fn::Not": [
        {
          "Fn::Equals": [
            {
              "Ref": "KmsKeyId"
            },
            "EMPTY"
          ]
        }
      ]
    },
    "IfDirectInternetAccess": {
      "Fn::Not": [
        {
          "Fn::Equals": [
            {
              "Ref": "DirectInternetAccess"
            },
            "EMPTY"
          ]
        }
      ]
    },
    "IfIdleShutdown": {
      "Fn::Not": [
        {
          "Fn::Equals": [
            {
              "Ref": "IdleShutdown"
            },
            "EMPTY"
          ]
        }
      ]
    },
    "IfGlueDevEndpoint": {
      "Fn::Not": [
        {
          "Fn::Equals": [
            {
              "Ref": "GlueDevEndpoint"
            },
            "EMPTY"
          ]
        }
      ]
    },
    "IfEnableRoot": {
      "Fn::Not": [
        {
          "Fn::Equals": [
            {
              "Ref": "EnableRoot"
            },
            "EMPTY"
          ]
        }
      ]
    },
    "YesIdleCheck": {
      "Fn::And": [
        {
          "Fn::Not": [
            {
              "Condition": "NoIdle"
            }
          ]
        },
        {
          "Condition": "TurnOn"
        }
      ]
    },
    "NoIdle": {
      "Fn::Equals": [
        {
          "Ref": "IdleShutdown"
        },
        "DISABLE"
      ]
    },
    "IfCreateKey": {
      "Fn::Equals": [
        {
          "Ref": "KmsKeyId"
        },
        "CREATE"
      ]
    },
    "IfCreateRole": {
      "Fn::Equals": [
        {
          "Ref": "RoleArn"
        },
        "CREATE"
      ]
    },
    "IfSecurityGroupId": {
      "Fn::Not": [
        {
          "Fn::Equals": [
            {
              "Ref": "SecurityGroupId"
            },
            ""
          ]
        }
      ]
    },
    "TurnOff": {
      "Fn::Equals": [
        {
          "Ref": "State"
        },
        "OFF"
      ]
    },
    "TurnOn": {
      "Fn::Equals": [
        {
          "Ref": "State"
        },
        "ON"
      ]
    },
    "CreateDocument": {
      "Fn::And": [
        {
          "Condition": "TurnOn"
        },
        {
          "Condition": "IfOnCreateDeleteDocument"
        }
      ]
    },
    "TurnOnDocument": {
      "Fn::And": [
        {
          "Condition": "TurnOn"
        },
        {
          "Condition": "IfOnStartStopDocument"
        }
      ]
    },
    "IfDisableDirectInternet": {
      "Fn::Not": [
        {
          "Fn::Equals": [
            {
              "Ref": "DirectInternetAccess"
            },
            "Enabled"
          ]
        }
      ]
    },
    "IfDisableRootAccess": {
      "Fn::Equals": [
        {
          "Ref": "EnableRoot"
        },
        "True"
      ]
    }
  },
  "Outputs": {
    "NoteBookName": {
      "Value": {
        "Fn::GetAtt": [
          "SageMakerNotebookInstance",
          "NotebookInstanceName"
        ]
      }
    },
    "InstanceID": {
      "Value": {
        "Fn::GetAtt": [
          "WaitConditionData",
          "id"
        ]
      }
    },
    "JupyterProxyCFNLambda": {
      "Value": {
        "Fn::GetAtt": [
          "JupyterApiProxyLambda",
          "Arn"
        ]
      }
    },
    "RoleArn": {
      "Value": {
        "Fn::GetAtt": [
          "Role",
          "Arn"
        ]
      }
    },
    "VolumeSize": {
      "Value": {
        "Ref": "VolumeSize"
      }
    },
    "CodeRepository": {
      "Value": {
        "Ref": "CodeRepository"
      }
    },
    "AcceleratorType": {
      "Value": {
        "Ref": "AcceleratorType"
      }
    },
    "State": {
      "Value": {
        "Ref": "State"
      }
    },
    "LambdaUtilLayer": {
      "Value": {
        "Ref": "LambdaUtilLayer"
      }
    },
    "OnStartStopDocument": {
      "Value": {
        "Ref": "OnStartStopDocument"
      }
    },
    "OnCreateDeleteDocument": {
      "Value": {
        "Ref": "OnCreateDeleteDocument"
      }
    },
    "ParentStack": {
      "Value": {
        "Ref": "ParentStack"
      }
    },
    "SSMLogGroup": {
      "Value": {
        "Ref": "SSMLogGroup"
      }
    },
    "LogsBucket": {
      "Value": {
        "Ref": "LogsBucket"
      }
    },
    "EFS": {
      "Value": {
        "Ref": "EFS"
      }
    },
    "InstanceType": {
      "Value": {
        "Ref": "InstanceType"
      }
    },
    "KmsKeyId": {
      "Value": {
        "Ref": "KmsKeyId"
      }
    },
    "SecurityGroupId": {
      "Value": {
        "Ref": "SecurityGroupId"
      }
    },
    "SubnetId": {
      "Value": {
        "Ref": "SubnetId"
      }
    },
    "DirectInternetAccess": {
      "Value": {
        "Ref": "DirectInternetAccess"
      }
    },
    "IdleShutdown": {
      "Value": {
        "Ref": "IdleShutdown"
      }
    },
    "GlueDevEndpoint": {
      "Value": {
        "Ref": "GlueDevEndpoint"
      }
    },
    "VPC": {
      "Value": {
        "Ref": "VPC"
      }
    },
    "EnableRoot": {
      "Value": {
        "Ref": "EnableRoot"
      }
    }
  },
  "Resources": {
    "JupyterApiProxyLambda": {
      "Type": "AWS::Lambda::Function",
      "Properties": {
        "Code": {
          "ZipFile": "var aws=require(\"aws-sdk\"),response=require(\"cfn-response\");aws.config.region=process.env.AWS_REGION||\"us-east-1\";var sagemaker=new aws.SageMaker,https=require(\"https\"),URL=require(\"url\");function send(args){return sagemaker.createPresignedNotebookInstanceUrl({NotebookInstanceName:args.InstanceName}).promise().then(function(result){console.log(result);var url=URL.parse(result.AuthorizedUrl);return console.log(url),new Promise(function(res,rej){var opts={hostname:url.hostname,protocol:url.protocol,post:443,path:`${url.pathname}${url.search}`,method:\"GET\"};console.log(opts);var req=https.request(opts,x=>{opts.headers={Cookie:x.headers[\"set-cookie\"].join(\"; \")},opts.path=x.headers.location,res(opts)});req.on(\"error\",rej),req.end()})}).then(opts=>(console.log(opts),new Promise(function(res,rej){var req=https.request(opts,x=>{opts.path=x.headers.location,res(opts)});req.on(\"error\",rej),req.end()}))).then(opts=>(console.log(opts),new Promise(function(res,rej){var req=https.request(opts,x=>{opts.path=args.path,opts.method=args.method,res(opts)});req.on(\"error\",rej),req.end()}))).then(opts=>{var body=[];return console.log(opts),new Promise(function(res,rej){var req=https.request(opts,response=>{response.on(\"data\",chunk=>{body.push(chunk)}),response.on(\"end\",()=>{res(Buffer.concat(body).toString())})});args.body&&req.write(args.body),req.on(\"error\",rej),req.end()})}).then(x=>{try{return JSON.parse(x)}catch(e){return x}})}exports.send=send,exports.handler=function(event,context,callback){console.log(JSON.stringify(event,null,2));var params=event.ResourceProperties[event.RequestType.toLowerCase()];params?(console.log(params),send(params).then(result=>{console.log(result),response.send(event,context,response.SUCCESS)}).catch(error=>{console.log(error),response.send(event,context,response.FAILED)})):response.send(event,context,response.SUCCESS)};"
        },
        "Handler": "index.handler",
        "MemorySize": "128",
        "Layers": [
          {
            "Ref": "LambdaUtilLayer"
          }
        ],
        "Environment": {
          "Variables": {
            "STACKNAME": {
              "Ref": "AWS::StackName"
            }
          }
        },
        "Role": {
          "Fn::GetAtt": [
            "CFNLambdaRole",
            "Arn"
          ]
        },
        "Runtime": "nodejs8.10",
        "Timeout": 60
      }
    },
    "NotebookLambda": {
      "Type": "AWS::Lambda::Function",
      "Properties": {
        "Code": {
          "ZipFile": "var aws=require(\"aws-sdk\"),response=require(\"cfn-response\"),CfnLambda=require(\"cfn-lambda\");aws.config.region=process.env.AWS_REGION;var _=require(\"lodash\"),ec2=new aws.EC2,lambda=new aws.Lambda,sagemaker=new aws.SageMaker,updateable=[\"AcceleratorTypes\",\"InstanceType\",\"RoleArn\",\"VolumeSizeInGB\",\"AdditionalCodeRepositories\",\"DefaultCodeRepository\"],handler=CfnLambda({Create:(params,reply)=>(params.VolumeSizeInGB=parseInt(params.VolumeSizeInGB),sagemaker.createNotebookInstance(params).promise().then(result=>reply(null,params.NotebookInstanceName,params)).catch(reply)),Update:(id,params,old,reply)=>(params.VolumeSizeInGB=parseInt(params.VolumeSizeInGB),old.VolumeSizeInGB=parseInt(old.VolumeSizeInGB),_.isEqual(_.pick(params,updateable),_.pick(old,updateable))?sagemaker.describeNotebookInstance({NotebookInstanceName:id}).promise().then(()=>reply(null,id,params)).catch(reply):sagemaker.updateNotebookInstance(_.pick(params,updateable.concat([\"NotebookInstanceName\"]))).promise().then(()=>reply(null,id,params)).catch(reply)),NoUpdate:(id,params,reply)=>sagemaker.describeNotebookInstance({NotebookInstanceName:id}).promise().then(x=>reply(null,id,x)).catch(reply),Delete:(id,params,reply)=>{sagemaker.describeNotebookInstance({NotebookInstanceName:id}).promise().then(x=>{if(\"InService\"===x.NotebookInstanceStatus)return sagemaker.stopNotebookInstance({NotebookInstanceName:id}).promise().then(x=>reply(null,id,x));[\"Stopped\",\"Stoping\"].includes(x.NotebookInstanceStatus)?reply(null,id,x):reply(x)}).catch(reply)},LongRunning:{PingInSeconds:5,MaxPings:1e5,LambdaApi:lambda,Methods:{Create:(context,params,reply,recurse)=>sagemaker.describeNotebookInstance({NotebookInstanceName:context.PhysicalResourceId}).promise().then(x=>{console.log(x),\"InService\"===x.NotebookInstanceStatus?reply(null,context.PhysicalResourceId,x):\"Pending\"===x.NotebookInstanceStatus?recurse():reply(x)}).catch(reply),Delete:(context,id,params,reply,recurse)=>sagemaker.describeNotebookInstance({NotebookInstanceName:id}).promise().then(x=>{\"InService\"===x.NotebookInstanceStatus?recurse():\"Stopping\"===x.NotebookInstanceStatus?recurse():[\"Failed\",\"Stopped\"].includes(x.NotebookInstanceStatus)?sagemaker.deleteNotebookInstance({NotebookInstanceName:id}).promise().then(x=>recurse()).catch(reply):reply(x)}).catch(e=>{if(\"RecordNotFound\"===e.message){var eni=context.Data.NetworkInterfaceId;ec2.describeNetworkInterfaces({NetworkInterfaceIds:[eni]}).promise().then(x=>ec2.deleteNetworkInterface({NetworkInterfaceId:eni}).promise()).then(x=>recurse()).catch(x=>{\"InvalidNetworkInterfaceID.NotFound\"===x.code?reply(null,id):reply(x)})}else sagemaker.deleteNotebookInstance({NotebookInstanceName:id}).promise().then(x=>recurse()).catch(reply)})}}});exports.handler=async function(event,context,callback){context.done;return new Promise((res,rej)=>{context.done=res,handler(event,context,callback)})};"
        },
        "Handler": "index.handler",
        "MemorySize": "128",
        "Layers": [
          {
            "Ref": "LambdaUtilLayer"
          }
        ],
        "Environment": {
          "Variables": {
            "STACKNAME": {
              "Ref": "AWS::StackName"
            }
          }
        },
        "Role": {
          "Fn::GetAtt": [
            "CFNLambdaRole",
            "Arn"
          ]
        },
        "Runtime": "nodejs8.10",
        "Timeout": 60
      }
    },
    "NotebookStateLambda": {
      "Type": "AWS::Lambda::Function",
      "Properties": {
        "Code": {
          "ZipFile": "var aws=require(\"aws-sdk\"),response=require(\"cfn-response\"),CfnLambda=require(\"cfn-lambda\");aws.config.region=process.env.AWS_REGION;var _=require(\"lodash\"),lambda=new aws.Lambda,sagemaker=new aws.SageMaker,handler=CfnLambda({Create:(params,reply)=>{startNotebook(params).then(x=>reply(null,params.notebook,params)).catch(reply)},Update:(id,params,old,reply)=>{reply(null,params.notebook,params)},Delete:(id,params,reply)=>{stopNotebook(params).then(x=>reply(null,params.notebook,params)).catch(reply)},LongRunning:{PingInSeconds:5,MaxPings:1e5,LambdaApi:lambda,Methods:{Create:(context,params,reply,recurse)=>sagemaker.describeNotebookInstance({NotebookInstanceName:context.PhysicalResourceId}).promise().then(x=>{console.log(x),\"InService\"===x.NotebookInstanceStatus?reply(null,context.PhysicalResourceId,x):\"Pending\"===x.NotebookInstanceStatus?recurse():(console.log(x),reply(x))}).catch(reply),Delete:(context,id,params,reply,recurse)=>sagemaker.describeNotebookInstance({NotebookInstanceName:id}).promise().then(x=>{\"InService\"===x.NotebookInstanceStatus?recurse():\"Stopping\"===x.NotebookInstanceStatus?recurse():\"Stopped\"===x.NotebookInstanceStatus?reply(null,id,params):(console.log(x),reply(x))})}}});function startNotebook(params){return sagemaker.describeNotebookInstance({NotebookInstanceName:params.notebook}).promise().then(x=>{if(console.log(JSON.stringify(x,null,2)),[\"Stopped\"].includes(x.NotebookInstanceStatus))return sagemaker.startNotebookInstance({NotebookInstanceName:params.notebook}).promise()})}function stopNotebook(params){return sagemaker.describeNotebookInstance({NotebookInstanceName:params.notebook}).promise().then(x=>{if(console.log(JSON.stringify(x,null,2)),[\"InService\"].includes(x.NotebookInstanceStatus))return sagemaker.stopNotebookInstance({NotebookInstanceName:params.notebook}).promise()})}exports.handler=async function(event,context,callback){context.done;return new Promise((res,rej)=>{context.done=res,handler(event,context,callback)})};"
        },
        "Handler": "index.handler",
        "MemorySize": "128",
        "Layers": [
          {
            "Ref": "LambdaUtilLayer"
          }
        ],
        "Environment": {
          "Variables": {
            "STACKNAME": {
              "Ref": "AWS::StackName"
            }
          }
        },
        "Role": {
          "Fn::GetAtt": [
            "CFNLambdaRole",
            "Arn"
          ]
        },
        "Runtime": "nodejs8.10",
        "Timeout": 60
      }
    },
    "ParameterUpdateLambda": {
      "Type": "AWS::Lambda::Function",
      "Properties": {
        "Code": {
          "ZipFile": "var response=require(\"cfn-response\"),aws=require(\"aws-sdk\");aws.config.region=process.env.AWS_REGION;var ssm=new aws.SSM;function isObject(item){return item&&\"object\"==typeof item&&!Array.isArray(item)}function isShallow(item){return!Array.isArray(item)||!item.find(item=>\"object\"==typeof item)}function assign(target,...sources){if(!sources.length)return target;const source=sources.shift();if(isObject(target)&&isObject(source))for(const key in source)isObject(source[key])?(target[key]||Object.assign(target,{[key]:{}}),assign(target[key],source[key])):isShallow(source[key])?Object.assign(target,{[key]:source[key]}):(target[key]||Object.assign(target,{[key]:[]}),Object.assign(target,{[key]:source[key].map((item,index)=>assign(target[key][index]||{},item))}));return assign(target,...sources)}exports.handler=function(event,context,callback){console.log(JSON.stringify(event,null,2));var params=event.ResourceProperties;delete params.ServiceToken,\"Delete\"!==event.RequestType?ssm.getParameter({Name:params.name}).promise().then(function(result){return console.log(JSON.stringify(result,null,2)),value=JSON.parse(result.Parameter.Value),value=assign(value,JSON.parse(params.value)),ssm.putParameter({Name:params.name,Type:result.Parameter.Type,Value:JSON.stringify(value),Overwrite:!0}).promise()}).then(()=>response.send(event,context,response.SUCCESS)).catch(e=>{console.log(e),response.send(event,context,response.FAILED)}):response.send(event,context,response.SUCCESS,params)};"
        },
        "Handler": "index.handler",
        "MemorySize": "128",
        "Layers": [
          {
            "Ref": "LambdaUtilLayer"
          }
        ],
        "Environment": {
          "Variables": {
            "STACKNAME": {
              "Ref": "AWS::StackName"
            }
          }
        },
        "Role": {
          "Fn::GetAtt": [
            "CFNLambdaRole",
            "Arn"
          ]
        },
        "Runtime": "nodejs8.10",
        "Timeout": 60
      }
    },
    "RoleNameLambda": {
      "Type": "AWS::Lambda::Function",
      "Properties": {
        "Code": {
          "ZipFile": "var response=require(\"cfn-response\");exports.handler=function(event,context,callback){console.log(JSON.stringify(event,null,2));try{var params=event.ResourceProperties,name=params.Arn.match(/arn:.*:.*::.*:role\\/(.*)/)[1];response.send(event,context,response.SUCCESS,params,name)}catch(e){console.log(e),response.send(event,context,response.FAILED,params,name)}};"
        },
        "Handler": "index.handler",
        "MemorySize": "128",
        "Layers": [
          {
            "Ref": "LambdaUtilLayer"
          }
        ],
        "Environment": {
          "Variables": {
            "STACKNAME": {
              "Ref": "AWS::StackName"
            }
          }
        },
        "Role": {
          "Fn::GetAtt": [
            "CFNLambdaRole",
            "Arn"
          ]
        },
        "Runtime": "nodejs8.10",
        "Timeout": 60
      }
    },
    "SSMActivationLambda": {
      "Type": "AWS::Lambda::Function",
      "Properties": {
        "Code": {
          "ZipFile": "var aws=require(\"aws-sdk\"),response=require(\"cfn-response\");aws.config.region=process.env.AWS_REGION;var ssm=new aws.SSM;exports.handler=function(event,context,callback){console.log(JSON.stringify(event,null,2));var params=event.ResourceProperties;delete params.ServiceToken,\"Create\"===event.RequestType?ssm.createActivation(params).promise().then(x=>{console.log(x),response.send(event,context,response.SUCCESS,x,x.ActivationId)}).catch(error=>{console.log(error),response.send(event,context,response.FAILED)}):\"Update\"===event.RequestType?response.send(event,context,response.SUCCESS,event.OldResourceProperties,event.PhysicalResourceId):ssm.describeInstanceInformation({Filters:[{Key:\"ActivationIds\",Values:[event.PhysicalResourceId]}]}).promise().then(x=>(console.log(JSON.stringify(x,null,2)),ssm.deregisterManagedInstance({InstanceId:x.InstanceInformationList[0].InstanceId}).promise())).then(x=>(console.log(JSON.stringify(x,null,2)),ssm.deleteActivation({ActivationId:event.PhysicalResourceId}).promise())).then(x=>response.send(event,context,response.SUCCESS)).catch(error=>{console.log(error),response.send(event,context,response.SUCCESS)})};"
        },
        "Handler": "index.handler",
        "MemorySize": "128",
        "Layers": [
          {
            "Ref": "LambdaUtilLayer"
          }
        ],
        "Environment": {
          "Variables": {
            "STACKNAME": {
              "Ref": "AWS::StackName"
            }
          }
        },
        "Role": {
          "Fn::GetAtt": [
            "CFNLambdaRole",
            "Arn"
          ]
        },
        "Runtime": "nodejs8.10",
        "Timeout": 60
      }
    },
    "SSMAssociationLambda": {
      "Type": "AWS::Lambda::Function",
      "Properties": {
        "Code": {
          "ZipFile": "var aws=require(\"aws-sdk\"),response=require(\"cfn-response\");aws.config.region=process.env.AWS_REGION;var ssm=new aws.SSM;exports.handler=function(event,context,callback){console.log(JSON.stringify(event,null,2));var params=event.ResourceProperties;params.AssociationName=event.LogicalResourceId,delete params.ServiceToken,\"Delete\"!==event.RequestType?ssm.createAssociation(params).promise().then(x=>{console.log(x),response.send(event,context,response.SUCCESS,x.AssociationDescription,x.AssociationDescription.AssociationId)}).catch(error=>{console.log(error),response.send(event,context,response.FAILED)}):ssm.deleteAssociation({AssociationId:event.PhysicalResourceId,InstanceId:params.InstanceId,Name:params.Name}).promise().then(()=>response.send(event,context,response.SUCCESS)).catch(error=>{console.log(error),response.send(event,context,response.SUCCESS)})};"
        },
        "Handler": "index.handler",
        "MemorySize": "128",
        "Layers": [
          {
            "Ref": "LambdaUtilLayer"
          }
        ],
        "Environment": {
          "Variables": {
            "STACKNAME": {
              "Ref": "AWS::StackName"
            }
          }
        },
        "Role": {
          "Fn::GetAtt": [
            "CFNLambdaRole",
            "Arn"
          ]
        },
        "Runtime": "nodejs8.10",
        "Timeout": 60
      }
    },
    "SSMRunLambda": {
      "Type": "AWS::Lambda::Function",
      "Properties": {
        "Code": {
          "ZipFile": "var aws=require(\"aws-sdk\"),response=require(\"cfn-response\"),CfnLambda=require(\"cfn-lambda\"),_=require(\"lodash\");aws.config.region=process.env.AWS_REGION;var ssm=new aws.SSM,util=require(\"ssm\"),lambda=new aws.Lambda;function Run(params,reply,event){return util.start(_.set(params.config,\"Parameters.Event\",[event])).then(x=>reply(null,x.id,x)).catch(err=>reply(err))}function check(context,params,reply,recurse){return get(context.PhysicalResourceId,params,context.Data).then(status=>{\"Success\"===status?reply(null,context.PhysicalResourceId):[\"Pending\",\"InProgress\",\"Delayed\"].includes(status)?recurse():reply(status)}).catch(reply)}function get(id,params,data){return\"Command\"===data.DocumentType?ssm.getCommandInvocation({CommandId:id,InstanceId:params.config.InstanceIds[0]}).promise().then(x=>x.Status):ssm.describeAutomationExecutions({Filters:[{Key:\"ExecutionId\",Values:[id]}]}).promise().then(x=>x.AutomationExecutionMetadataList[0].AutomationExecutionStatus)}exports.handler=CfnLambda({Create:(params,reply)=>Run(params,reply,\"Create\"),Update:(id,params,old,reply)=>reply(null,id),Delete:(id,params,reply)=>Run(params,reply,\"Delete\"),LongRunning:{PingInSeconds:5,MaxPings:1e5,LambdaApi:lambda,Methods:{Create:(context,params,reply,recurse)=>{check(context,params,reply,recurse)},Delete:(context,id,params,reply,recurse)=>{check(context,params,reply,recurse)}}}});"
        },
        "Handler": "index.handler",
        "MemorySize": "128",
        "Layers": [
          {
            "Ref": "LambdaUtilLayer"
          }
        ],
        "Environment": {
          "Variables": {
            "STACKNAME": {
              "Ref": "AWS::StackName"
            }
          }
        },
        "Role": {
          "Fn::GetAtt": [
            "CFNLambdaRole",
            "Arn"
          ]
        },
        "Runtime": "nodejs8.10",
        "Timeout": 60
      }
    },
    "SSMTagsLambda": {
      "Type": "AWS::Lambda::Function",
      "Properties": {
        "Code": {
          "ZipFile": "var aws=require(\"aws-sdk\"),response=require(\"cfn-response\");aws.config.region=process.env.AWS_REGION;var ssm=new aws.SSM;exports.handler=function(event,context,callback){console.log(JSON.stringify(event,null,2));var params=event.ResourceProperties;delete params.ServiceToken,\"Delete\"!==event.RequestType?ssm.addTagsToResource(params).promise().then(x=>{console.log(x),response.send(event,context,response.SUCCESS)}).catch(error=>{console.log(error),response.send(event,context,response.FAILED)}):response.send(event,context,response.SUCCESS)};"
        },
        "Handler": "index.handler",
        "MemorySize": "128",
        "Layers": [
          {
            "Ref": "LambdaUtilLayer"
          }
        ],
        "Environment": {
          "Variables": {
            "STACKNAME": {
              "Ref": "AWS::StackName"
            }
          }
        },
        "Role": {
          "Fn::GetAtt": [
            "CFNLambdaRole",
            "Arn"
          ]
        },
        "Runtime": "nodejs8.10",
        "Timeout": 60
      }
    },
    "VariableLambda": {
      "Type": "AWS::Lambda::Function",
      "Properties": {
        "Code": {
          "ZipFile": "var response=require(\"cfn-response\");exports.handler=function(event,context,callback){console.log(JSON.stringify(event,null,2));var params=event.ResourceProperties;delete params.ServiceToken,Object.keys(params).forEach(function(key){var value=params[key];\"object\"==typeof value&&(\"toLowerCase\"===value.op?params[key]=value.value.toLowerCase():params[key]=value.value)}),response.send(event,context,response.SUCCESS,params)};"
        },
        "Handler": "index.handler",
        "MemorySize": "128",
        "Layers": [
          {
            "Ref": "LambdaUtilLayer"
          }
        ],
        "Environment": {
          "Variables": {
            "STACKNAME": {
              "Ref": "AWS::StackName"
            }
          }
        },
        "Role": {
          "Fn::GetAtt": [
            "CFNLambdaRole",
            "Arn"
          ]
        },
        "Runtime": "nodejs8.10",
        "Timeout": 60
      }
    },
    "WaitDataParseLambda": {
      "Type": "AWS::Lambda::Function",
      "Properties": {
        "Code": {
          "ZipFile": "var response=require(\"cfn-response\");exports.handler=function(event,context,callback){console.log(JSON.stringify(event,null,2));var params=event.ResourceProperties;delete params.ServiceToken;try{response.send(event,context,response.SUCCESS,JSON.parse(params.Data))}catch(e){console.log(e),response.send(event,context,response.FAILED)}};"
        },
        "Handler": "index.handler",
        "MemorySize": "128",
        "Layers": [
          {
            "Ref": "LambdaUtilLayer"
          }
        ],
        "Environment": {
          "Variables": {
            "STACKNAME": {
              "Ref": "AWS::StackName"
            }
          }
        },
        "Role": {
          "Fn::GetAtt": [
            "CFNLambdaRole",
            "Arn"
          ]
        },
        "Runtime": "nodejs8.10",
        "Timeout": 60
      }
    },
    "testLambda": {
      "Type": "AWS::Lambda::Function",
      "Properties": {
        "Code": {
          "ZipFile": "var aws=require(\"aws-sdk\");aws.config.region=process.env.AWS_REGION||\"us-east-1\";var sagemaker=new aws.SageMaker,https=require(\"https\"),URL=require(\"url\");async function send(args){return sagemaker.createPresignedNotebookInstanceUrl({NotebookInstanceName:args.InstanceName}).promise().then(function(result){console.log(result);var url=URL.parse(result.AuthorizedUrl);return console.log(url),new Promise(function(res,rej){var opts={hostname:url.hostname,protocol:url.protocol,post:443,path:`${url.pathname}${url.search}`,method:\"GET\"};console.log(opts);var req=https.request(opts,x=>{opts.headers={Cookie:x.headers[\"set-cookie\"].join(\"; \")},opts.path=x.headers.location,res(opts)});req.on(\"error\",rej),req.end()})}).then(opts=>(console.log(opts),new Promise(function(res,rej){var req=https.request(opts,x=>{opts.path=x.headers.location,res(opts)});req.on(\"error\",rej),req.end()}))).then(opts=>(console.log(opts),new Promise(function(res,rej){var req=https.request(opts,x=>{opts.path=args.path,opts.method=args.method,res(opts)});req.on(\"error\",rej),req.end()}))).then(opts=>{var body=[];return console.log(opts),new Promise(function(res,rej){var req=https.request(opts,response=>{response.on(\"data\",chunk=>{body.push(chunk)}),response.on(\"end\",()=>{res(Buffer.concat(body).toString())})});args.body&&req.write(args.body),req.on(\"error\",rej),req.end()})}).then(x=>{try{return JSON.parse(x)}catch(e){return x}})}send({InstanceName:\"SageMakerNotebookInstance-nSPgAasgJ6yt\",path:\"/api/status\",method:\"GET\"}).then(x=>console.log(JSON.stringify(x,null,2)));"
        },
        "Handler": "index.handler",
        "MemorySize": "128",
        "Layers": [
          {
            "Ref": "LambdaUtilLayer"
          }
        ],
        "Environment": {
          "Variables": {
            "STACKNAME": {
              "Ref": "AWS::StackName"
            }
          }
        },
        "Role": {
          "Fn::GetAtt": [
            "CFNLambdaRole",
            "Arn"
          ]
        },
        "Runtime": "nodejs8.10",
        "Timeout": 60
      }
    },
    "CFNLambdaRole": {
      "Type": "AWS::IAM::Role",
      "Properties": {
        "AssumeRolePolicyDocument": {
          "Version": "2012-10-17",
          "Statement": [
            {
              "Effect": "Allow",
              "Principal": {
                "Service": "lambda.amazonaws.com"
              },
              "Action": "sts:AssumeRole"
            }
          ]
        },
        "Path": "/",
        "ManagedPolicyArns": [
          "arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole",
          "arn:aws:iam::aws:policy/AmazonSSMFullAccess",
          "arn:aws:iam::aws:policy/AmazonSageMakerFullAccess",
          {
            "Ref": "CFNPolicy"
          }
        ]
      }
    },
    "CFNPolicy": {
      "Type": "AWS::IAM::ManagedPolicy",
      "Properties": {
        "PolicyDocument": {
          "Version": "2012-10-17",
          "Statement": [
            {
              "Effect": "Allow",
              "Action": [
                "iam:PassRole",
                "lambda:InvokeFunction",
                "cloudformation:*"
              ],
              "Resource": [
                "*"
              ]
            },
            {
              "Fn::If": [
                "IfKmsKeyId",
                {
                  "Effect": "Allow",
                  "Action": [
                    "kms:CreateGrant"
                  ],
                  "Resource": {
                    "Fn::If": [
                      "IfCreateKey",
                      {
                        "Fn::GetAtt": [
                          "KMSKey",
                          "Arn"
                        ]
                      },
                      {
                        "Fn::Sub": "arn:aws:kms:${AWS::Region}:${AWS::AccountId}:key/${KmsKeyId}"
                      }
                    ]
                  }
                },
                {
                  "Ref": "AWS::NoValue"
                }
              ]
            }
          ]
        }
      }
    },
    "SageMakerNotebookInstanceState": {
      "Type": "Custom::NotebookInstanceState",
      "DependsOn": "SageMakerNotebookInstance",
      "Condition": "TurnOn",
      "Properties": {
        "ServiceToken": {
          "Fn::GetAtt": [
            "NotebookStateLambda",
            "Arn"
          ]
        },
        "notebook": {
          "Fn::GetAtt": [
            "SageMakerNotebookInstance",
            "NotebookInstanceName"
          ]
        }
      }
    },
    "SageMakerNotebookInstance": {
      "Type": "Custom::NotebookInstance",
      "Properties": {
        "ServiceToken": {
          "Fn::GetAtt": [
            "NotebookLambda",
            "Arn"
          ]
        },
        "VolumeSizeInGB": {
          "Ref": "VolumeSize"
        },
        "InstanceType": {
          "Ref": "InstanceType"
        },
        "NotebookInstanceName": {
          "Ref": "AWS::StackName"
        },
        "RoleArn": {
          "Fn::GetAtt": [
            "Role",
            "Arn"
          ]
        },
        "LifecycleConfigName": {
          "Fn::GetAtt": [
            "SageMakerNotebookLifecycle",
            "NotebookInstanceLifecycleConfigName"
          ]
        },
        "SecurityGroupIds": [
          {
            "Ref": "SecurityGroupId"
          }
        ],
        "SubnetId": {
          "Ref": "SubnetId"
        },
        "DefaultCodeRepository": {
          "Fn::If": [
            "IfCodeRepository",
            {
              "Ref": "CodeRepository"
            },
            {
              "Ref": "AWS::NoValue"
            }
          ]
        },
        "AcceleratorTypes": {
          "Fn::If": [
            "IfAcceleratorType",
            [
              {
                "Ref": "AcceleratorType"
              }
            ],
            {
              "Ref": "AWS::NoValue"
            }
          ]
        },
        "KmsKeyId": {
          "Fn::If": [
            "IfCreateKey",
            {
              "Ref": "KMSKey"
            },
            {
              "Fn::If": [
                "IfKmsKeyId",
                {
                  "Ref": "KmsKeyId"
                },
                {
                  "Ref": "AWS::NoValue"
                }
              ]
            }
          ]
        },
        "DirectInternetAccess": {
          "Fn::If": [
            "IfDisableDirectInternet",
            {
              "Ref": "DirectInternetAccess"
            },
            {
              "Ref": "AWS::NoValue"
            }
          ]
        },
        "RootAccess": {
          "Fn::If": [
            "IfDisableRootAccess",
            "Disabled",
            "Enabled"
          ]
        },
        "Tags": [
          {
            "Key": "Project",
            "Value": "aws-sagemaker-guard"
          }
        ]
      }
    },
    "SageMakerNotebookLifecycle": {
      "Type": "AWS::SageMaker::NotebookInstanceLifecycleConfig",
      "Properties": {
        "OnCreate": [
          {
            "Content": {
              "Fn::Base64": {
                "Fn::Sub": "#! /bin/bash\nset -ex \n\nstop amazon-ssm-agent\nyum install -y https://s3.amazonaws.com/ec2-downloads-windows/SSMAgent/latest/linux_amd64/amazon-ssm-agent.rpm amazon-efs-utils\nstop amazon-ssm-agent\n\nmkdir -p /mnt/efs\nmount -t efs ${EFS}:/ /mnt/efs\nmkdir -p /mnt/efs/${AWS::StackName}/ssm\nrm -rf /mnt/efs/${AWS::StackName}/ssm/*\n\nmount -t efs ${EFS}:/${AWS::StackName}/ssm /var/lib/amazon/ssm\n\n\ncat > /etc/amazon/ssm/seelog.xml <<- EOM\n<seelog type=\"adaptive\" mininterval=\"2000000\" maxinterval=\"100000000\" critmsgcount=\"500\" minlevel=\"info\">\n    <exceptions>\n        <exception filepattern=\"test*\" minlevel=\"error\"/>\n    </exceptions>\n    <outputs formatid=\"fmtinfo\">\n        <console formatid=\"fmtinfo\"/>\n        <rollingfile type=\"size\" filename=\"/var/log/amazon/ssm/amazon-ssm-agent.log\" maxsize=\"30000000\" maxrolls=\"5\"/>\n        <filter levels=\"error,critical\" formatid=\"fmterror\">\n            <rollingfile type=\"size\" filename=\"/var/log/amazon/ssm/errors.log\" maxsize=\"10000000\" maxrolls=\"5\"/>\n        </filter>\n        <custom name=\"cloudwatch_receiver\" formatid=\"fmtdebug\" data-log-group=\"${SSMLogGroup}\"/>\n    </outputs>    \n    <formats>\n        <format id=\"fmterror\" format=\"%Date %Time %LEVEL [%FuncShort @ %File.%Line] %Msg%n\"/>        \n        <format id=\"fmtdebug\" format=\"%Date %Time %LEVEL [%FuncShort @ %File.%Line] %Msg%n\"/>\n        <format id=\"fmtinfo\" format=\"%Date %Time %LEVEL %Msg%n\"/>    \n    </formats>\n</seelog>\nEOM\n\namazon-ssm-agent -register -y \\\n    -code \"${SSMActivation.ActivationCode}\" \\\n    -id \"${SSMActivation.ActivationId}\" \\\n    -region \"${AWS::Region}\"\n\nstart amazon-ssm-agent\n\nID=$(cat /var/lib/amazon/ssm/Vault/Store/RegistrationKey | jq '.instanceID' --raw-output)\n\n/opt/aws/bin/cfn-signal --success=true --data=$ID --id=id \"${WaitHandle}\"\n"
              }
            }
          }
        ],
        "OnStart": [
          {
            "Content": {
              "Fn::Base64": {
                "Fn::Sub": "#! /bin/bash\nset -ex \n\nstop amazon-ssm-agent\nif [ ! -d /mnt/efs ]; then\n    yum install -y https://s3.amazonaws.com/ec2-downloads-windows/SSMAgent/latest/linux_amd64/amazon-ssm-agent.rpm amazon-efs-utils\n    stop amazon-ssm-agent\n\n    mkdir -p /mnt/efs\n    mount -t efs ${EFS}:/ /mnt/efs\n    mkdir -p /mnt/efs/${AWS::StackName}/ssm\n    mount -t efs ${EFS}:/${AWS::StackName}/ssm /var/lib/amazon/ssm\nfi\n\nID=$(cat /var/lib/amazon/ssm/Vault/Store/RegistrationKey | jq '.instanceID' --raw-output)\ncat >> /etc/awslogs/awslogs.conf<<- EOM\n\n[/var/log/jupyter.log]\nfile = /var/log/jupyter*\nbuffer_duration = 5000\nlog_stream_name = $ID-jupyter\n/LifecycleConfigOnStartinitial_position = start_of_file\nlog_group_name = ${SSMLogGroup}\nEOM\nservice awslogs restart\n\ncat > /etc/amazon/ssm/seelog.xml <<- EOM\n<seelog type=\"adaptive\" mininterval=\"2000000\" maxinterval=\"100000000\" critmsgcount=\"500\" minlevel=\"info\">\n    <exceptions>\n        <exception filepattern=\"test*\" minlevel=\"error\"/>\n    </exceptions>\n    <outputs formatid=\"fmtinfo\">\n        <console formatid=\"fmtinfo\"/>\n        <rollingfile type=\"size\" filename=\"/var/log/amazon/ssm/amazon-ssm-agent.log\" maxsize=\"30000000\" maxrolls=\"5\"/>\n        <filter levels=\"error,critical\" formatid=\"fmterror\">\n            <rollingfile type=\"size\" filename=\"/var/log/amazon/ssm/errors.log\" maxsize=\"10000000\" maxrolls=\"5\"/>\n        </filter>\n        <custom name=\"cloudwatch_receiver\" formatid=\"fmtdebug\" data-log-group=\"${SSMLogGroup}\"/>\n    </outputs>    \n    <formats>\n        <format id=\"fmterror\" format=\"%Date %Time %LEVEL [%FuncShort @ %File.%Line] %Msg%n\"/>        \n        <format id=\"fmtdebug\" format=\"%Date %Time %LEVEL [%FuncShort @ %File.%Line] %Msg%n\"/>\n        <format id=\"fmtinfo\" format=\"%Date %Time %LEVEL %Msg%n\"/>    \n    </formats>\n</seelog>\nEOM\n\nstart amazon-ssm-agent\n\nif [ \"${GlueDevEndpoint}\" != \"EMPTY\" ]; then \n    set -ex\n    [ -e /home/ec2-user/glue_ready ] && exit 0\n     \n    mkdir /home/ec2-user/glue\n    cd /home/ec2-user/glue\n    DEV_ENDPOINT_NAME=${GlueDevEndpoint}\n    aws s3 cp s3://aws-glue-jes-prod-us-east-1-assets/sagemaker/assets/ . --recursive\n     \n    tar -xf autossh-1.4e.tgz\n    cd autossh-1.4e\n    ./configure\n    make\n    sudo make install\n    pip install pandas==0.22.0\n     \n    mkdir -p /home/ec2-user/.sparkmagic\n    cp /home/ec2-user/glue/config.json /home/ec2-user/.sparkmagic/config.json\n     \n    mkdir -p /home/ec2-user/SageMaker/Glue\\ Examples\n    mv /home/ec2-user/glue/notebook-samples/* /home/ec2-user/SageMaker/Glue\\ Examples/\n     \n    sudo cp /home/ec2-user/glue/autossh.conf /etc/init/\n    python3 /home/ec2-user/glue/bootstrap.py --devendpointname $DEV_ENDPOINT_NAME --endpoint https://glue.${AWS::Region}.amazonaws.com --notebookname $ID\n    sudo touch /home/ec2-user/glue_ready\nfi\n"
              }
            }
          }
        ]
      }
    },
    "SSMActivation": {
      "Type": "Custom::SSMActivation",
      "Properties": {
        "ServiceToken": {
          "Fn::GetAtt": [
            "SSMActivationLambda",
            "Arn"
          ]
        },
        "IamRole": {
          "Ref": "SSMRole"
        },
        "DefaultInstanceName": {
          "Ref": "AWS::StackName"
        },
        "RegistrationLimit": 1
      }
    },
    "WaitConditionData": {
      "Type": "Custom::WaitDataParse",
      "Properties": {
        "ServiceToken": {
          "Fn::GetAtt": [
            "WaitDataParseLambda",
            "Arn"
          ]
        },
        "Data": {
          "Fn::GetAtt": [
            "WaitCondition",
            "Data"
          ]
        }
      }
    },
    "SSMRole": {
      "Type": "AWS::IAM::Role",
      "Properties": {
        "AssumeRolePolicyDocument": {
          "Version": "2012-10-17",
          "Statement": [
            {
              "Effect": "Allow",
              "Principal": {
                "Service": "ssm.amazonaws.com"
              },
              "Action": "sts:AssumeRole"
            }
          ]
        },
        "Path": "/",
        "ManagedPolicyArns": [
          "arn:aws:iam::aws:policy/service-role/AmazonEC2RoleforSSM"
        ],
        "Policies": [
          {
            "PolicyName": "Access2",
            "PolicyDocument": {
              "Version": "2012-10-17",
              "Statement": [
                {
                  "Effect": "Allow",
                  "Action": [
                    "cloudformation:DescribeStacks"
                  ],
                  "Resource": "*"
                }
              ]
            }
          },
          {
            "Fn::If": [
              "IfGlueDevEndpoint",
              {
                "PolicyName": "Access",
                "PolicyDocument": {
                  "Version": "2012-10-17",
                  "Statement": [
                    {
                      "Effect": "Allow",
                      "Action": [
                        "glue:GetDevEndpoint",
                        "glue:UpdateDevEndpoint"
                      ],
                      "Resource": {
                        "Fn::Sub": "arn:aws:glue:${AWS::Region}:${AWS::AccountId}:devEndpoint/${GlueDevEndpoint}"
                      }
                    }
                  ]
                }
              },
              {
                "Ref": "AWS::NoValue"
              }
            ]
          }
        ]
      }
    },
    "WaitHandle": {
      "Type": "AWS::CloudFormation::WaitConditionHandle",
      "Properties": {}
    },
    "WaitCondition": {
      "Type": "AWS::CloudFormation::WaitCondition",
      "Properties": {
        "Handle": {
          "Ref": "WaitHandle"
        },
        "Timeout": "900",
        "Count": "1"
      }
    },
    "KMSKey": {
      "Type": "AWS::KMS::Key",
      "Condition": "IfCreateKey",
      "Properties": {
        "Description": {
          "Fn::Sub": "Key created for notebook instance ${AWS::StackName}"
        },
        "Enabled": true,
        "PendingWindowInDays": 7,
        "Tags": [
          {
            "Value": {
              "Ref": "AWS::StackName"
            },
            "Key": "SageGuard"
          }
        ],
        "KeyPolicy": {
          "Version": "2012-10-17",
          "Statement": [
            {
              "Sid": "Enable IAM User Permissions",
              "Effect": "Allow",
              "Principal": {
                "AWS": {
                  "Fn::Sub": "arn:aws:iam::${AWS::AccountId}:root"
                }
              },
              "Action": "kms:*",
              "Resource": "*"
            }
          ]
        }
      }
    },
    "RunCreateDeleteDocument": {
      "Type": "Custom::RunDocument",
      "Condition": "CreateDocument",
      "Properties": {
        "ServiceToken": {
          "Fn::GetAtt": [
            "SSMRunLambda",
            "Arn"
          ]
        },
        "State": {
          "Ref": "SageMakerNotebookInstanceState"
        },
        "config": {
          "DocumentName": {
            "Ref": "OnCreateDeleteDocument"
          },
          "Parameters": {
            "VolumeSize": [
              {
                "Ref": "VolumeSize"
              }
            ],
            "CodeRepository": [
              {
                "Ref": "CodeRepository"
              }
            ],
            "AcceleratorType": [
              {
                "Ref": "AcceleratorType"
              }
            ],
            "State": [
              {
                "Ref": "State"
              }
            ],
            "LambdaUtilLayer": [
              {
                "Ref": "LambdaUtilLayer"
              }
            ],
            "ParentStack": [
              {
                "Ref": "ParentStack"
              }
            ],
            "SSMLogGroup": [
              {
                "Ref": "SSMLogGroup"
              }
            ],
            "LogsBucket": [
              {
                "Ref": "LogsBucket"
              }
            ],
            "EFS": [
              {
                "Ref": "EFS"
              }
            ],
            "InstanceType": [
              {
                "Ref": "InstanceType"
              }
            ],
            "RoleArn": [
              {
                "Fn::GetAtt": [
                  "Role",
                  "Arn"
                ]
              }
            ],
            "KmsKeyId": [
              {
                "Ref": "KmsKeyId"
              }
            ],
            "SecurityGroupId": [
              {
                "Ref": "SecurityGroupId"
              }
            ],
            "SubnetId": [
              {
                "Ref": "SubnetId"
              }
            ],
            "DirectInternetAccess": [
              {
                "Ref": "DirectInternetAccess"
              }
            ],
            "IdleShutdown": [
              {
                "Ref": "IdleShutdown"
              }
            ],
            "GlueDevEndpoint": [
              {
                "Ref": "GlueDevEndpoint"
              }
            ],
            "VPC": [
              {
                "Ref": "VPC"
              }
            ],
            "EnableRoot": [
              {
                "Ref": "EnableRoot"
              }
            ],
            "InstanceId": [
              {
                "Fn::GetAtt": [
                  "WaitConditionData",
                  "id"
                ]
              }
            ],
            "StackName": [
              {
                "Ref": "AWS::StackName"
              }
            ],
            "SSMRoleArn": [
              {
                "Fn::GetAtt": [
                  "SSMRole",
                  "Arn"
                ]
              }
            ]
          },
          "InstanceIds": [
            {
              "Fn::GetAtt": [
                "WaitConditionData",
                "id"
              ]
            }
          ],
          "OutputS3BucketName": {
            "Ref": "LogsBucket"
          },
          "OutputS3KeyPrefix": {
            "Fn::Sub": "${AWS::StackName}/Start/"
          },
          "OutputS3Region": {
            "Ref": "AWS::Region"
          }
        }
      }
    },
    "RunStartStopDocument": {
      "Type": "Custom::Lifecycle",
      "Condition": "TurnOnDocument",
      "DependsOn": [
        "SageMakerNotebookInstance"
      ],
      "Properties": {
        "ServiceToken": {
          "Fn::GetAtt": [
            "SSMRunLambda",
            "Arn"
          ]
        },
        "State": {
          "Ref": "SageMakerNotebookInstanceState"
        },
        "config": {
          "DocumentName": {
            "Ref": "OnStartStopDocument"
          },
          "Parameters": {
            "VolumeSize": [
              {
                "Ref": "VolumeSize"
              }
            ],
            "CodeRepository": [
              {
                "Ref": "CodeRepository"
              }
            ],
            "AcceleratorType": [
              {
                "Ref": "AcceleratorType"
              }
            ],
            "State": [
              {
                "Ref": "State"
              }
            ],
            "LambdaUtilLayer": [
              {
                "Ref": "LambdaUtilLayer"
              }
            ],
            "ParentStack": [
              {
                "Ref": "ParentStack"
              }
            ],
            "SSMLogGroup": [
              {
                "Ref": "SSMLogGroup"
              }
            ],
            "LogsBucket": [
              {
                "Ref": "LogsBucket"
              }
            ],
            "EFS": [
              {
                "Ref": "EFS"
              }
            ],
            "InstanceType": [
              {
                "Ref": "InstanceType"
              }
            ],
            "RoleArn": [
              {
                "Fn::GetAtt": [
                  "Role",
                  "Arn"
                ]
              }
            ],
            "KmsKeyId": [
              {
                "Ref": "KmsKeyId"
              }
            ],
            "SecurityGroupId": [
              {
                "Ref": "SecurityGroupId"
              }
            ],
            "SubnetId": [
              {
                "Ref": "SubnetId"
              }
            ],
            "DirectInternetAccess": [
              {
                "Ref": "DirectInternetAccess"
              }
            ],
            "IdleShutdown": [
              {
                "Ref": "IdleShutdown"
              }
            ],
            "GlueDevEndpoint": [
              {
                "Ref": "GlueDevEndpoint"
              }
            ],
            "VPC": [
              {
                "Ref": "VPC"
              }
            ],
            "EnableRoot": [
              {
                "Ref": "EnableRoot"
              }
            ],
            "InstanceId": [
              {
                "Fn::GetAtt": [
                  "WaitConditionData",
                  "id"
                ]
              }
            ],
            "StackName": [
              {
                "Ref": "AWS::StackName"
              }
            ],
            "SSMRoleArn": [
              {
                "Fn::GetAtt": [
                  "SSMRole",
                  "Arn"
                ]
              }
            ]
          },
          "InstanceIds": [
            {
              "Fn::GetAtt": [
                "WaitConditionData",
                "id"
              ]
            }
          ],
          "OutputS3BucketName": {
            "Ref": "LogsBucket"
          },
          "OutputS3KeyPrefix": {
            "Fn::Sub": "${AWS::StackName}/Start/"
          },
          "OutputS3Region": {
            "Ref": "AWS::Region"
          }
        }
      }
    },
    "InstanceSSMTags": {
      "Type": "Custom::SSMTags",
      "Properties": {
        "ServiceToken": {
          "Fn::GetAtt": [
            "SSMTagsLambda",
            "Arn"
          ]
        },
        "ResourceId": {
          "Fn::GetAtt": [
            "WaitConditionData",
            "id"
          ]
        },
        "ResourceType": "ManagedInstance",
        "Tags": [
          {
            "Key": "Project",
            "Value": "SageGuard"
          },
          {
            "Key": "Name",
            "Value": {
              "Ref": "AWS::StackName"
            }
          },
          {
            "Key": "Stack",
            "Value": {
              "Ref": "ParentStack"
            }
          }
        ]
      }
    },
    "CheckIdle": {
      "Type": "AWS::Events::Rule",
      "Condition": "YesIdleCheck",
      "Properties": {
        "ScheduleExpression": {
          "Fn::Sub": "rate(${IdleShutdown} minutes)"
        },
        "Targets": [
          {
            "Arn": {
              "Fn::GetAtt": [
                "CloudWatchIdleLambda",
                "Arn"
              ]
            },
            "Id": "idle"
          }
        ]
      }
    },
    "CloudWatchIdleLambda": {
      "Type": "AWS::Lambda::Function",
      "Properties": {
        "Code": {
          "ZipFile": "var aws=require(\"aws-sdk\"),axios=require(\"axios\");aws.config.region=process.env.AWS_REGION||\"us-east-1\";var sagemaker=new aws.SageMaker,cf=new aws.CloudFormation,https=require(\"https\"),_=require(\"lodash\"),URL=require(\"url\");function stop(){return cf.describeStacks({StackName:process.env.STACKNAME}).promise().then(x=>{if([\"CREATE_COMPLETE\",\"ROLLBACK_COMPLETE\",\"UPDATE_COMPLETE\",\"UPDATE_ROLLBACK_COMPLETE\"].includes(x.Stacks[0].StackStatus)){var Parameters=_.fromPairs(x.Stacks[0].Parameters.map(y=>[y.ParameterKey,y.ParameterValue]));return Parameters.State=\"OFF\",cf.updateStack({StackName:process.env.STACKNAME,Capabilities:[\"CAPABILITY_NAMED_IAM\"],UsePreviousTemplate:!0,Parameters:_.toPairs(Parameters).map(y=>({ParameterKey:y[0],ParameterValue:y[1]}))}).promise().catch(error=>{if(\"No updates are to be performed.\"!==error.message)throw error})}throw new Error(`Stack currently in state ${x.Stacks[0].StackStatus}`)})}function init(args){return sagemaker.createPresignedNotebookInstanceUrl({NotebookInstanceName:args.InstanceName}).promise().then(function(result){var url=URL.parse(result.AuthorizedUrl);return axios({url:result.AuthorizedUrl,method:\"GET\",maxRedirects:0}).catch(error=>{if(302===error.response.status)return console.log(\"authenticated\"),axios.create({baseURL:`https://${url.host}/api`,headers:{Cookie:error.response.headers[\"set-cookie\"].join(\"; \")}});throw Error})})}exports.handler=((event,context,cb)=>{console.log(JSON.stringify(event,null,2));var timeout=6e4*process.env.IDLETIME;new Date;init({InstanceName:process.env.INSTANCE}).then(client=>{client.get(\"status\").then(response=>{if(console.log(JSON.stringify(response.data,null,2)),0===response.data.connections){var now=new Date,last=new Date(response.data.last_activity);if(console.log(now-last,timeout),now-last>timeout)return console.log(\"instance has timed out. will shutdown\"),stop();console.log(\"instance has not timed out.\")}})}).catch(console.log)});"
        },
        "Handler": "index.handler",
        "MemorySize": "1024",
        "Layers": [
          {
            "Ref": "LambdaUtilLayer"
          }
        ],
        "Role": {
          "Fn::GetAtt": [
            "CloudWatchLambdaRole",
            "Arn"
          ]
        },
        "Runtime": "nodejs8.10",
        "Environment": {
          "Variables": {
            "INSTANCE": {
              "Fn::GetAtt": [
                "SageMakerNotebookInstance",
                "NotebookInstanceName"
              ]
            },
            "IDLETIME": {
              "Ref": "IdleShutdown"
            },
            "STACKNAME": {
              "Ref": "AWS::StackName"
            }
          }
        },
        "TracingConfig": {
          "Mode": "Active"
        },
        "Timeout": 60,
        "Tags": [
          {
            "Key": "Type",
            "Value": "CloudWatch"
          }
        ]
      }
    },
    "CheckIdlePermissionIdle": {
      "Type": "AWS::Lambda::Permission",
      "Condition": "YesIdleCheck",
      "Properties": {
        "Action": "lambda:InvokeFunction",
        "FunctionName": {
          "Fn::GetAtt": [
            "CloudWatchIdleLambda",
            "Arn"
          ]
        },
        "Principal": "events.amazonaws.com",
        "SourceArn": {
          "Fn::GetAtt": [
            "CheckIdle",
            "Arn"
          ]
        }
      }
    },
    "CloudWatchLambdaRole": {
      "Type": "AWS::IAM::Role",
      "Properties": {
        "AssumeRolePolicyDocument": {
          "Version": "2012-10-17",
          "Statement": [
            {
              "Effect": "Allow",
              "Principal": {
                "Service": "lambda.amazonaws.com"
              },
              "Action": "sts:AssumeRole"
            }
          ]
        },
        "Path": "/",
        "ManagedPolicyArns": [
          "arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole",
          "arn:aws:iam::aws:policy/AWSXrayWriteOnlyAccess",
          "arn:aws:iam::aws:policy/AmazonSageMakerFullAccess"
        ],
        "Policies": [
          {
            "PolicyName": "Access",
            "PolicyDocument": {
              "Version": "2012-10-17",
              "Statement": [
                {
                  "Effect": "Allow",
                  "Action": [
                    "cloudformation:*"
                  ],
                  "Resource": {
                    "Fn::Sub": "arn:aws:cloudformation:${AWS::Region}:${AWS::AccountId}:stack/${AWS::StackName}/*"
                  }
                },
                {
                  "Effect": "Allow",
                  "Action": [
                    "cloudformation:DescribeStacks"
                  ],
                  "Resource": "*"
                }
              ]
            }
          }
        ]
      }
    },
    "Role": {
      "Type": "Custom::RoleName",
      "Properties": {
        "ServiceToken": {
          "Fn::GetAtt": [
            "VariableLambda",
            "Arn"
          ]
        },
        "Arn": {
          "Fn::If": [
            "IfCreateRole",
            {
              "Fn::GetAtt": [
                "DefaultNotebookRole",
                "Arn"
              ]
            },
            {
              "Ref": "RoleArn"
            }
          ]
        }
      }
    },
    "DefaultNotebookRole": {
      "Type": "AWS::IAM::Role",
      "Condition": "IfCreateRole",
      "Properties": {
        "AssumeRolePolicyDocument": {
          "Version": "2012-10-17",
          "Statement": [
            {
              "Effect": "Allow",
              "Principal": {
                "Service": "sagemaker.amazonaws.com"
              },
              "Action": "sts:AssumeRole"
            }
          ]
        },
        "Path": "/",
        "ManagedPolicyArns": [
          "arn:aws:iam::aws:policy/AmazonSageMakerFullAccess"
        ]
      }
    }
  },
  "AWSTemplateFormatVersion": "2010-09-09",
  "Description": ""
}